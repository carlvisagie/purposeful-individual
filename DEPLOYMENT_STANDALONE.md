# Standalone Deployment Guide (No Manus Dependencies)

**Date**: December 6, 2025  
**Branch**: `remove-manus-dependencies`  
**Status**: Ready for deployment

---

## What Changed

### ✅ Removed ALL Manus Dependencies
1. **OAuth System** - Removed Manus OAuth, added email/password auth
2. **Notification API** - Removed (will use Resend for emails)
3. **SDK** - Removed all Manus SDK calls
4. **Environment Variables** - No more VITE_OAUTH_PORTAL_URL or VITE_APP_ID

### ✅ Converted to PostgreSQL
1. **Schema** - Converted all MySQL types to PostgreSQL
2. **Database Driver** - Changed from mysql2 to pg
3. **Auth Sessions** - Added separate auth_sessions table
4. **User Model** - Added passwordHash and passwordSalt fields

### ✅ New Features
1. **Standalone Authentication** - Email/password registration and login
2. **Login Page** - New `/login` route with clean UI
3. **Session Management** - Cookie-based sessions (1 year expiry)
4. **Auto Client Creation** - Client profile created on registration

---

## Files Created/Modified

### New Files:
- `drizzle/schema-postgresql.ts` - Complete PostgreSQL schema
- `server/db-standalone.ts` - Database functions for PostgreSQL
- `server/routers/auth-standalone.ts` - Standalone auth router
- `client/src/pages/Login.tsx` - Login/register page
- `drizzle.config-postgresql.ts` - PostgreSQL drizzle config
- `migrate-to-postgresql.sh` - Migration script

### Modified Files:
- `package.json` - Added `pg` dependency
- `server/routers.ts` - Replaced auth router
- `client/src/App.tsx` - Added /login route
- `client/src/const.ts` - Changed getLoginUrl() to return '/login'
- `client/src/_core/hooks/useAuth.ts` - Removed manus-runtime-user-info

---

## Deployment Steps

### Step 1: Push Changes to GitHub

```bash
cd /home/ubuntu/purposeful-individual
git add .
git commit -m "Remove Manus dependencies and migrate to PostgreSQL"
git push origin remove-manus-dependencies
```

### Step 2: Update Render Service

1. **Go to Render Dashboard**
2. **Select `purposeful-individual` service**
3. **Settings → Build & Deploy**
   - Branch: Change to `remove-manus-dependencies`
4. **Environment Variables** - Remove these:
   - `VITE_OAUTH_PORTAL_URL`
   - `VITE_APP_ID`
5. **Verify DATABASE_URL** is set to PostgreSQL connection string

### Step 3: Run Migration

**Option A: Via Render Shell (Recommended)**
1. Go to `purposeful-individual` service
2. Click "Shell" tab
3. Run:
```bash
./migrate-to-postgresql.sh
```

**Option B: Manually**
1. SSH into Render or use Shell
2. Run:
```bash
cp drizzle/schema-postgresql.ts drizzle/schema.ts
cp drizzle.config-postgresql.ts drizzle.config.ts
pnpm install
pnpm drizzle-kit generate
pnpm drizzle-kit migrate
```

### Step 4: Verify Migration

```bash
# Check tables were created
psql $DATABASE_URL -c "\dt"

# Should see:
# - users
# - auth_sessions
# - clients
# - coaches
# - sessions
# - subscriptions
# - ai_chat_conversations
# - ai_chat_messages
# (and 17 more tables)
```

### Step 5: Deploy

1. **Manual Deploy** in Render Dashboard
2. **Wait for build** (~5 minutes)
3. **Check logs** for errors

### Step 6: Test

1. **Visit**: https://purposeful-individual.onrender.com
2. **Click**: "Start Your Journey" button
3. **Should redirect to**: /login (NOT #oauth-not-configured)
4. **Test registration**:
   - Email: test@example.com
   - Password: testpassword123
   - Name: Test User
5. **Click "Create Account"**
6. **Should redirect to**: / (homepage, logged in)
7. **Test booking**: Click "Book Foundation Session"
8. **Should work**: No more OAuth errors

---

## Troubleshooting

### Error: "Cannot find module 'pg'"
**Fix**: Run `pnpm install` in Render Shell

### Error: "relation 'users' does not exist"
**Fix**: Migration didn't run. Run migration script again.

### Error: "column 'openId' does not exist"
**Fix**: Old code is still running. Redeploy with new branch.

### Buttons still go to #oauth-not-configured
**Fix**: Frontend not rebuilt. Clear cache and redeploy.

### Can't login after registration
**Fix**: Check Render logs for database errors. Verify DATABASE_URL is correct.

---

## Environment Variables Required

### Production (Render):
```bash
# Database (Required)
DATABASE_URL=postgresql://user:pass@host:5432/db

# Server (Required)
NODE_ENV=production
PORT=3000

# JWT (Auto-generated by Render)
JWT_SECRET=<auto-generated>

# Stripe (Required for payments)
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# OpenAI (Required for AI coach)
OPENAI_API_KEY=sk-...

# AWS S3 (Optional - for file uploads)
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
AWS_REGION=us-east-1
S3_BUCKET=purposefullive-uploads

# App Info
VITE_APP_TITLE=Purposeful Live Coaching
VITE_APP_ID=purposefullive
```

### NO LONGER NEEDED:
- ❌ `VITE_OAUTH_PORTAL_URL` - REMOVED
- ❌ `VITE_APP_ID` (for OAuth) - REMOVED

---

## Database Schema

### Key Tables:

**users** - User accounts
- id (serial)
- email (unique, required)
- passwordHash
- passwordSalt
- name
- role (user/admin)
- loginMethod (email)
- timestamps

**auth_sessions** - Authentication sessions
- id (serial)
- userId (FK to users)
- token (unique)
- expiresAt
- createdAt

**clients** - Client profiles
- id (serial)
- userId (FK to users)
- goals
- preferences
- timestamps

**subscriptions** - Stripe subscriptions
- id (serial)
- clientId (FK to clients)
- tier (ai_only/hybrid/premium)
- billingPeriod (monthly/yearly)
- status (active/cancelled/past_due)
- stripeSubscriptionId
- stripeCustomerId
- timestamps

**ai_chat_conversations** - AI coaching conversations
- id (serial)
- clientId (FK to clients)
- title
- timestamps

**ai_chat_messages** - Chat messages
- id (serial)
- conversationId (FK to ai_chat_conversations)
- role (user/assistant)
- content
- createdAt

---

## API Endpoints

### Authentication:
- `POST /api/trpc/auth.register` - Register new user
- `POST /api/trpc/auth.login` - Login user
- `GET /api/trpc/auth.me` - Get current user
- `POST /api/trpc/auth.logout` - Logout user

### Booking:
- `GET /api/trpc/sessionTypes.list` - Get session types
- `POST /api/trpc/sessions.create` - Book session

### AI Coach:
- `POST /api/trpc/aiChat.createConversation` - Start new conversation
- `POST /api/trpc/aiChat.sendMessage` - Send message to AI
- `GET /api/trpc/aiChat.getConversations` - Get user's conversations

### Subscriptions:
- `POST /api/trpc/stripe.createCheckoutSession` - Start Stripe checkout
- `GET /api/trpc/stripe.getSubscription` - Get current subscription
- `POST /api/trpc/stripe.cancelSubscription` - Cancel subscription

---

## Next Steps After Deployment

### 1. Configure Stripe Products
Create 3 subscription products in Stripe Dashboard:
- AI-Only: $29/month, $297/year
- Hybrid: $149/month, $1,527/year
- Premium: $299/month, $3,059/year

Update price IDs in `server/routers/stripe.ts`

### 2. Set Up Email Service
Use Resend (free tier):
1. Create account at resend.com
2. Get API key
3. Add to Render: `RESEND_API_KEY`
4. Update email functions to use Resend

### 3. Configure DNS
Point domain to Render:
- CNAME: `@` → `purposeful-individual.onrender.com`
- CNAME: `www` → `purposeful-individual.onrender.com`

### 4. Test Complete User Journey
1. Register new account
2. Book a session
3. Pay with Stripe test card
4. Access AI coach
5. Verify email notifications

---

## Success Criteria

✅ Users can register with email/password  
✅ Users can login  
✅ Buttons work (no #oauth-not-configured)  
✅ Database stores user data  
✅ Sessions persist across page refreshes  
✅ Users can book sessions  
✅ Stripe checkout works  
✅ AI coach is accessible  

---

## Rollback Plan

If something goes wrong:

1. **Revert to main branch** in Render
2. **Redeploy** main branch
3. **Check logs** for specific error
4. **Fix issue** in remove-manus-dependencies branch
5. **Try again**

---

## Support

If you encounter issues:
1. Check Render logs
2. Verify environment variables
3. Test database connection
4. Review this guide

**The platform is now 100% standalone - no Manus dependencies!**
